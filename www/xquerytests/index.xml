<?xml-stylesheet href="xsl/xsltforms.xsl" type="text/xsl"?>
<?xsltforms-options domengine="name=Fleur;url=js/fleur.js;uri=http://www.agencexml.com/Fleur;version=1.0"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xf="http://www.w3.org/2002/xforms" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:qt="http://www.w3.org/2010/09/qt-fots-catalog">
	<head>
		<title>XQuery Test Suite</title>
		<xf:model>
			<xf:instance>
				<qt:test-set/>
			</xf:instance>
			<xf:instance id="catalog" src="data/catalog.xml"/>
			<xf:instance id="test-set">
				<qt:test-set/>
			</xf:instance>
			<xf:submission method="get" replace="instance" instance="test-set" serialization="none">
				<xf:resource value="concat('data/',.)"/>
			</xf:submission>
		</xf:model>
		<script type="text/javascript">
			var parser = new Fleur.DOMParser();
			function xqeval(envfile, xexpr) {
				try {
				    var xmlBuf = "\x3cdummy/\x3e";
					var xmldoc = parser.parseFromString(xmlBuf, "application/xml");
					var nsResolver = function(element) {
						return {
							defaultNamespace: element.getAttribute("xmlns"),
							nsresolver: element.ownerDocument.createNSResolver(element),
							lookupNamespaceURI: function(prefix) {
								if (prefix === "_") {
									return this.defaultNamespace;
								}
								return this.nsresolver.lookupNamespaceURI(prefix);
							}
						};
					};
					var res = xmldoc.evaluate(xexpr, xmldoc, nsResolver(xmldoc.documentElement), Fleur.XPathResult.ANY_TYPE, null).toXQuery();
					return res;
				} catch(e) {
					return "Exception!\n" + e.stack;
				}
			}
		</script>
	</head>
	<body>
		<xf:select1 ref=".">
			<xf:label>Test Set: </xf:label>
			<xf:itemset ref="instance('catalog')/qt:test-set">
				<xf:label ref="@name"/>
				<xf:value ref="@file"/>
			</xf:itemset>
			<xf:send ev:event="xforms-value-changed"/>
		</xf:select1>
		<table border="1">
			<tbody>
				<xf:repeat id="tests" ref="instance('test-set')/qt:test-case">
					<tr>
						<td style="width:100px"><xf:output value="qt:test"/></td>
						<td>
							<xf:trigger>
								<xf:label>Run</xf:label>
								<xf:load ev:event="DOMActivate" show="new">
									<xf:resource value="concat('runtest.htm?test=', encodeURIComponent(qt:test), '&amp;resultstring=', encodeURIComponent(qt:result-string), '&amp;environment=', encodeURIComponent(../qt:environment[@name = current()/qt:environment/@ref]/qt:source/@file))"/>
								</xf:load>
							</xf:trigger>
						</td>
						<td style="width:100px">
							<xf:var name="xqres" value="xqeval(../qt:environment[@name = current()/qt:environment/@ref]/qt:source/@file, qt:test)"/>
							<span style="color:{choose($xqres = qt:result-string, 'green', 'red')}"><xf:output value="$xqres"/></span>
						</td>
						<td style="width:100px"><xf:output value="qt:result-string"/></td>
					</tr>
				</xf:repeat>
			</tbody>
		</table>
	</body>
</html>